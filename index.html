<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ExamQuestions</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64' width='64' height='64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%234CAF50' stroke='%232E7D32' stroke-width='2'/%3E%3Crect x='18' y='16' width='28' height='36' rx='2' fill='white' stroke='%23ddd' stroke-width='1'/%3E%3Cline x1='22' y1='24' x2='42' y2='24' stroke='%23333' stroke-width='1.5' opacity='0.7'/%3E%3Cline x1='22' y1='28' x2='42' y2='28' stroke='%23333' stroke-width='1.5' opacity='0.7'/%3E%3Cline x1='22' y1='32' x2='38' y2='32' stroke='%23333' stroke-width='1.5' opacity='0.7'/%3E%3Ccircle cx='32' cy='40' r='6' fill='%23FF9800' stroke='%23F57C00' stroke-width='1'/%3E%3Ctext x='32' y='45' text-anchor='middle' font-family='Arial, sans-serif' font-size='8' font-weight='bold' fill='white'%3E?%3C/text%3E%3C/svg%3E">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="dropdown.css">
</head>
<body>
  <form onsubmit="return validarFormulario()">
    <label for="sistema">Sistema:</label>
    <select id="sistema" name="sistema" onchange="atualizarSubopcoes()">
      <option value="">-- Escolha um sistema --</option>
      <option value="servicenow">ServiceNow</option>
      <!-- Outros sistemas -->
    </select>

    <label for="subopcaoCustom">Exams:</label>
    <div id="subopcaoCustom" class="dropdown-container">
      <div class="dropdown-selected">-- Choose an exam --</div>
      <div class="dropdown-options"></div>
      <input type="hidden" id="subopcaoValue" name="subopcao">
    </div>

    <label for="email">Email:</label>
    <input type="email" id="email" name="email" required>

    <button type="submit">Submeter</button>
  </form>

  <!-- Modal de Confirmação -->
  <div id="modalFundo" class="modal">
    <div class="modal-content">
      <p>Confirmas os seguintes dados?</p>
      <p><strong>Sistema:</strong> <span id="confSistema"></span></p>
      <p><strong>Exame:</strong> <span id="confSubopcao"></span></p>
      <p><strong>Email:</strong> <span id="confEmail"></span></p>
      <button id="btnSim">Sim</button>
      <button onclick="document.getElementById('modalFundo').style.display='none'">Não</button>
    </div>
  </div>

  <!-- Modal de Sucesso -->
  <div id="modalSucesso" class="modal">
    <div class="modal-content">
      <p>Submissão concluída com sucesso!</p>
      <button onclick="document.getElementById('modalSucesso').style.display='none'">Fechar</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

    const firebaseConfig = {
      // a tua config
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let subopcoesPorSistema = {};

    fetch("subopcoes.json")
      .then(resp => resp.json())
      .then(data => {
        subopcoesPorSistema = data;
      });

    const dropdownContainer = document.getElementById("subopcaoCustom");
    const dropdownSelected = dropdownContainer.querySelector(".dropdown-selected");
    const dropdownOptions = dropdownContainer.querySelector(".dropdown-options");
    const hiddenInput = document.getElementById("subopcaoValue");

    window.atualizarSubopcoes = function () {
      const sistema = document.getElementById("sistema").value;
      dropdownOptions.innerHTML = "";
      hiddenInput.value = "";
      dropdownSelected.textContent = "-- Choose an exam --";

      if (sistema && subopcoesPorSistema[sistema]) {
        subopcoesPorSistema[sistema].forEach(opcao => {
          const div = document.createElement("div");
          div.classList.add("dropdown-option");
          div.dataset.value = opcao.value;
          div.dataset.label = opcao.label;
          div.innerHTML = `
            <span class="code">${opcao.value.toUpperCase()}:</span>
            <span class="desc">${opcao.label.split(":"[1])?.trim() || ""}</span>
          `;
          div.addEventListener("click", () => {
            dropdownSelected.innerHTML = div.innerHTML;
            hiddenInput.value = div.dataset.value;
            dropdownOptions.style.display = "none";
          });
          dropdownOptions.appendChild(div);
        });
      }
    };

    dropdownSelected.addEventListener("click", () => {
      dropdownOptions.style.display = dropdownOptions.style.display === "block" ? "none" : "block";
    });

    document.addEventListener("click", e => {
      if (!dropdownContainer.contains(e.target)) {
        dropdownOptions.style.display = "none";
      }
    });

    window.validarFormulario = function () {
      const sistema = document.getElementById("sistema").value;
      const subopcao = hiddenInput.value;
      const email = document.getElementById("email").value.trim();

      if (!sistema || !subopcao || !email) {
        alert("Por favor preenche todos os campos.");
        return false;
      }

      document.getElementById("confSistema").textContent = sistema;
      document.getElementById("confSubopcao").textContent = dropdownContainer.querySelector(`.dropdown-option[data-value='${subopcao}']`).dataset.label;
      document.getElementById("confSubopcao").dataset.value = subopcao;
      document.getElementById("confEmail").textContent = email;

      document.getElementById("modalFundo").style.display = "flex";
      return false;
    };

    document.getElementById("btnSim").addEventListener("click", () => {
      const sistema = document.getElementById("confSistema").textContent;
      const subopcao = document.getElementById("confSubopcao").dataset.value;
      const email = document.getElementById("confEmail").textContent;

      push(ref(db, "respostas"), {
        sistema,
        subopcao,
        email,
        timestamp: new Date().toISOString()
      })
        .then(() => {
          document.getElementById("modalSucesso").style.display = "flex";
          limparFormulario();
        });

      document.getElementById("modalFundo").style.display = "none";
    });

    function limparFormulario() {
      document.getElementById("sistema").value = "";
      document.getElementById("email").value = "";
      atualizarSubopcoes();
    }
  </script>
</body>
</html>